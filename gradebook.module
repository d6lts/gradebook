<?php
// $Id$

// hook_help
function gradebook_help($section) {
  switch ($section) {
    case 'admin/modules#description':
      // This description is shown in the listing at admin/modules.
      return t('Provides a simple gradebook UI.');
  }
}

// hook_perm
function gradebook_perm() {
  return array('view gradebook', 'view own gradebook', 'edit gradebook');
}

// hook_menu
function gradebook_menu($may_cache) {
  $items = array();
  
  // The $may_cache parameter is used to divide menu items into two parts. Those
  // returned when $may_cache is true must be consistently applicable for the
  // current user at all times; the others may change or be defined at only
  // certain paths. Most modules will have excusively cacheable menu items.
  if ($may_cache) {
    $items[] = array(
      'path'     => 'gradebook',
      'title'    => t('gradebook'),
      'access'   => user_access('view gradebook')||user_access('view own gradebook'),
      'callback' => 'gradebook_page',
    );
  }
  else {
    theme_add_style(drupal_get_path('module', 'gradebook') .'/gradebook.css');
    if (is_numeric(arg(1)) || (variable_get('gradebook_show_default', 1))) {
      $gradebook = (is_numeric(arg(1))?gradebookapi_gradebook_load(arg(1)):gradebookapi_default_gradebook_load());
      if (is_numeric(arg(1))) {
        $items[] = array(
          'path'               => _gradebook_base_url(),
          'title'              => t('view'),
          'type'               => MENU_CALLBACK,
          'callback'           => 'gradebook_gradebook_page',
          'callback arguments' => array($gradebook),
        );
      }
      $items[] = array(
        'path'               => _gradebook_base_url().'/view',
        'title'              => t('view'),
        'type'               => MENU_DEFAULT_LOCAL_TASK,
        'weight'             => -10,
      );
      $items[] = array(
        'path'               => _gradebook_base_url().'/rebuild',
        'title'              => t('rebuild'),
        'access'             => user_access('edit gradebook'),
        'callback'           => 'gradebook_rebuild_page',
        'callback arguments' => array($gradebook),
        'type'               => MENU_LOCAL_TASK,
      );
      $items[] = array(
        'path'               => _gradebook_base_url().'/category',
        'title'              => t('categories'),
        'access'             => user_access('edit gradebook'),
        'callback'           => 'gradebook_category_page',
        'callback arguments' => array($gradebook),
        'type'               => MENU_LOCAL_TASK,
      );
      $items[] = array(
        'path'               => _gradebook_base_url().'/category/list',
        'title'              => t('list'),
        'type'               => MENU_DEFAULT_LOCAL_TASK,
        'weight'             => -10,
      );
      $items[] = array(
        'path'               => _gradebook_base_url().'/category/add',
        'title'              => t('add category'),
        'access'             => user_access('edit gradebook'),
        'callback'           => 'gradebook_category_form',
        'callback arguments' => array($gradebook),
        'type'               => MENU_LOCAL_TASK,
      );
      
      if (is_numeric(arg(1))) {
        if ((arg(2)=='category') && (arg(3)=='edit') && is_numeric(arg(4))) {
          $tid = arg(4);
          $term = taxonomy_get_term($tid);
          $items[] = array(
            'path' => _gradebook_base_url().'/category/edit',
            'title' => t('edit category'),
            'callback' => 'gradebook_category_form',
            'callback arguments' => array($gradebook, (array)$term),
            'access' => user_access('edit gradebook'),
            'type' => MENU_CALLBACK,
          );
        }
        if ((arg(2)=='grade') && is_numeric(arg(3)) && is_numeric(arg(4))) {
          $uid = arg(3);
          $nid = arg(4);
          $grade = gradebookapi_get_grade($uid, $nid);
          $items[] = array(
            'path' => _gradebook_base_url().'/grade',
            'title' => t('edit grade'),
            'callback' => 'gradebook_grade_form',
            'callback arguments' => array($gradebook, (array)$grade),
            'access' => user_access('edit gradebook'),
            'type' => MENU_CALLBACK,
          );
        }
      }
      elseif (variable_get('gradebook_show_default', 1)) {
        if ((arg(1)=='category') && (arg(2)=='edit') && is_numeric(arg(3))) {
          $tid = arg(3);
          $term = taxonomy_get_term($tid);
          $items[] = array(
            'path' => _gradebook_base_url().'/category/edit',
            'title' => t('edit category'),
            'callback' => 'gradebook_category_form',
            'callback arguments' => array($gradebook, (array)$term),
            'access' => user_access('edit gradebook'),
            'type' => MENU_CALLBACK,
          );
        }
        if ((arg(1)=='grade') && is_numeric(arg(2)) && is_numeric(arg(3))) {
          $uid = arg(2);
          $nid = arg(3);
          $grade = gradebookapi_get_grade($uid, $nid);
          $items[] = array(
            'path' => _gradebook_base_url().'/grade',
            'title' => t('edit grade'),
            'callback' => 'gradebook_grade_form',
            'callback arguments' => array($gradebook, (array)$grade),
            'access' => user_access('edit gradebook'),
            'type' => MENU_CALLBACK,
          );
        }
      }
    }
  }
  return $items;
}

// hook_settings
// TODO: break out hard coded settings
function gradebook_settings() {
  $form = array();
  
  $roles = user_roles();
  unset($roles[DRUPAL_ANONYMOUS_RID]);
  
  $sel_roles = (array) variable_get('gradebook_student_rids', array());
  $default = array();
  foreach ($sel_roles as $rid => $value) {
    if ($value) {
      $default[] = $rid;
    }
  }
  $form['gradebook_student_rids'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Student roles'),
    '#default_value' => $default,
    '#options' => $roles,
    '#description' =>  t('Check at least one role.'),
    '#required' => TRUE,
  );
  
  $sel_roles = (array) variable_get('gradebook_teacher_rids', array());
  $default = array();
  foreach ($sel_roles as $rid => $value) {
    if ($value) {
      $default[] = $rid;
    }
  }
  $form['gradebook_teacher_rids'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Teacher roles'),
    '#default_value' => $default,
    '#options' => $roles,
    '#description' =>  t('Check at least one role.'),
    '#required' => TRUE,
  );
  
  $form['gradebook_show_default'] = array(
    '#type' => 'checkbox',
    '#title' => t('Show default gradebook'),
    '#default_value' => variable_get('gradebook_show_default', 1),
    '#description' =>  t('Show the default gradebook or list gradebooks.'),
  );
  
  $form['gradebook_empty_grade'] = array(
    '#type' => 'textfield',
    '#title' => t('Empty grade'),
    '#default_value' => variable_get('gradebook_empty_grade', '--'),
    '#description' =>  t('This the text displayed when no grade has been entered.'),
    '#required' => TRUE,
  );
  
  return $form;
}

function gradebook_page($gid = 0) {
  global $user;
  
  // TODO: where should these taxonomy module checks go?
  if (module_exist('taxonomy')) {
    // show default gradebook or list?
    if (variable_get('gradebook_show_default', 1) && (!$gid)) {
      $gradebook = gradebookapi_default_gradebook_load();
    }
    else {
      $gradebook = gradebookapi_gradebook_load($gid);
    }
    
    // show a gradebook
    if ($gradebook) {
      return gradebook_gradebook_page($gradebook);
    }
    // show a list of gradebooks
    else {
      return gradebook_list();
    }
  }
  else {
    drupal_set_message(t('The gradebook module requires the taxonomy module to be enabled and configured.'), 'error');
    return ' ';
  }
}

function gradebook_list() {
  $vid = gradebookapi_get_vid();
  $terms = taxonomy_get_tree($vid, 0, -1, 1);
  
  $header = array();
  foreach ($terms as $term) {
    $rows[] = array(l($term->name, _gradebook_base_url().'/'.$term->tid));
  }
  
  return theme('table', $header, $rows);
}

function gradebook_gradebook_page($gradebook) {
  $assignments = array();
  $student_grades = array();

  // gradebookapi_select_nodes($gradebook, $tids = array(), $operator = 'or', $depth = 0, $pager = TRUE, $order = 'n.sticky DESC, n.created DESC')
  $result = gradebookapi_select_nodes($gradebook, $tids, 'or', 0, FALSE, 'n.created ASC');
  while ($assignment = db_fetch_object($result)) {
    $assignments[$assignment->nid] = node_load($assignment->nid);
  }

  if (user_access('view gradebook')) {
    $str_rids = implode(',', array_keys(_gradebook_student_roles()));
    $result = db_query("SELECT u.uid, u.name FROM {users} u INNER JOIN {users_roles} r ON u.uid = r.uid WHERE u.status != 0 AND r.rid IN (". $str_rids .") ORDER BY u.name ASC");
  }
  else {
    $result = db_query("SELECT uid, name FROM {users} WHERE uid=%d", $user->uid);
  }
  while ($account = db_fetch_object($result)) {
    $student_grades[$account->uid] = array();
    foreach ($assignments as $assignment) {
      $student_grades[$account->uid][$assignment->nid] = gradebookapi_get_grade($account->uid, $assignment->nid);
    }
    $student_grades[$account->uid]['total'] = gradebookapi_get_term_grade($account->uid, $gradebook->tid);
  }
  
  return theme('gradebook_page', $gradebook, $assignments, $student_grades);
}

function theme_gradebook_page($gradebook, $assignments, $student_grades) {
  $headers = array();
  $rows = array();
  
  $vid = gradebookapi_get_vid();
  $categories = taxonomy_get_children($gradebook->tid, $vid);
  $category_tids = array();
  $assignments_sorted = array('root'=>array());
  
  $found = FALSE;
  
  // collect tids from categories
  foreach ($categories as $category) {
    $tree = taxonomy_get_tree(gradebookapi_get_vid(), $category->tid);
    $category_tids[$category->tid][] = $category->tid;
    $category_tids[$category->tid] = array_merge($category_tids[$category->tid], array_map('_taxonomy_get_tid_from_term', $tree));
  }
  
  // sort assignments
  foreach ($assignments as $assignment) {
    $found = FALSE;
    $terms = taxonomy_node_get_terms($assignment->nid);
    foreach ($terms as $term) {
      // make sure we only look in the gradebook vocabulary
      if ($term->vid == $vid) {
        // search category tids
        foreach ($category_tids as $categorytid => $tids) {
          if (in_array($term->tid, $tids)) {
            $assignments_sorted[$categorytid][$assignment->nid] = $assignment;
            $found = TRUE;
          }
        }
      }
    }
    // assignment is not in a category
    if (!$found) {
      $assignments_sorted['root'][$assignment->nid] = $assignment;
    }
  }
  
  $header1 = array();
  $header2 = array();
  $header1[] = array('data'=>'', 'class'=>'category'); // student name
  $header2[] = array('data'=>'', 'class'=>'assignment'); // student name
  foreach ($categories as $category) {
    if (count($assignments_sorted[$category->tid])) {
      $header1[] = array('data'=>$category->name, 'colspan'=>count($assignments_sorted[$category->tid]), 'class'=>'category');
      foreach ($assignments_sorted[$category->tid] as $assignment) {
        $header2[] = l($assignment->title, 'node/'.$assignment->nid) . '<br />' . $assignment->possible;
      }
    }
  }
  if (count($assignments_sorted['root'])) {
    $header1[] = array('data'=>'', 'colspan'=>count($assignments_sorted['root']), 'class'=>'assignment');
    foreach ($assignments_sorted['root'] as $assignment) {
      $header2[] = l($assignment->title, 'node/'.$assignment->nid) . '<br />' . $assignment->possible;
    }
  }
  $header1[] = array('data'=>'', 'class'=>'category'); // total grade
  $header2[] = array('data'=>'', 'class'=>'assignment'); // total grade
  $headers[] = $header1;
  $headers[] = $header2;
  
  foreach ($student_grades as $uid => $grades) {
    $row = array();
    
    $account = user_load(array('uid'=>$uid));
    $row[] = theme('username', $account);
    
    foreach ($categories as $category) {
      if (count($assignments_sorted[$category->tid])) {
        foreach ($assignments_sorted[$category->tid] as $assignment) {
          $grade = $grades[$assignment->nid];
          if (user_access('edit gradebook')) {
            $row[] = l(($grade->earned?$grade->earned:variable_get('gradebook_empty_grade', '--')), _gradebook_base_url().'/grade/'.$account->uid.'/'.$assignment->nid);
          }
          else {
            $row[] = ($grade->earned?$grade->earned:variable_get('gradebook_empty_grade', '--'));
          }
        }
      }
    }
    if (count($assignments_sorted['root'])) {
      foreach ($assignments_sorted['root'] as $assignment) {
        $grade = $grades[$assignment->nid];
        if (user_access('edit gradebook')) {
          $row[] = l(($grade->earned?$grade->earned:variable_get('gradebook_empty_grade', '--')), _gradebook_base_url().'/grade/'.$account->uid.'/'.$assignment->nid);
        }
        else {
          $row[] = ($grade->earned?$grade->earned:variable_get('gradebook_empty_grade', '--'));
        }
      }
    }

    $grade = gradebookapi_get_term_grade($account->uid, $gradebook->tid);
    $row[] = $grade->earned . '/' . $grade->possible;
    $rows[] = $row;
  }

  return theme('gradebook_table', $headers, $rows, array('class'=>'gradebook'));
}

function theme_gradebook_table($headers, $rows, $attributes = array(), $caption = NULL) {
  $output = '<table'. drupal_attributes($attributes) .">\n";

  if (isset($caption)) {
    $output .= '<caption>'. $caption ."</caption>\n";
  }

  // Format the table header:
  if (count($headers)) {
    $output .= ' <thead>';
    foreach ($headers as $header) {
      $ts = tablesort_init($header);
      $output .= '  <tr>';
      foreach ($header as $cell) {
        $cell = tablesort_header($cell, $header, $ts);
        $output .= _theme_table_cell($cell, 1);
      }
      $output .= '  </tr>';
    }
    $output .= " </thead>\n";
  }

  // Format the table rows:
  $output .= "<tbody>\n";
  if (count($rows)) {
    foreach ($rows as $number => $row) {
      $attributes = array();

      // Check if we're dealing with a simple or complex row
      if (isset($row['data'])) {
        foreach ($row as $key => $value) {
          if ($key == 'data') {
            $cells = $value;
          }
          else {
            $attributes[$key] = $value;
          }
        }
      }
      else {
        $cells = $row;
      }

      // Add odd/even class
      $class = ($number % 2 == 1) ? 'even': 'odd';
      if (isset($attributes['class'])) {
        $attributes['class'] .= ' '. $class;
      }
      else {
        $attributes['class'] = $class;
      }

      // Build row
      $output .= ' <tr'. drupal_attributes($attributes) .'>';
      $i = 0;
      foreach ($cells as $cell) {
        $cell = tablesort_cell($cell, $header, $ts, $i++);
        $output .= _theme_table_cell($cell, 0);
      }
      $output .= " </tr>\n";
    }
  }

  $output .= "</tbody></table>\n";
  return $output;
}

function theme_gradebook_page_old($gradebook, $assignments, $student_grades) {
  $header = array();
  $rows = array();
  
  //return 'theme_gradebook_page('.print_r($gradebook, TRUE).', '.print_r($assignments, TRUE).', '.print_r($student_grades, TRUE).')';
  
  // TODO: how should we render categories?
  
  $header[] = ''; // student name
  foreach ($assignments as $assignment) {
    $header[] = l($assignment->title, 'node/'.$assignment->nid) . '<br />' . $assignment->possible;
  }
  $header[] = ''; // total grade
  
  foreach ($student_grades as $uid => $grades) {
    $account = user_load(array('uid'=>$uid));
    $row = array();
    $row[] = theme('username', $account);
    foreach ($assignments as $assignment) {
      $grade = $grades[$assignment->nid];
      if (user_access('edit gradebook')) {
        $row[] = l(($grade->earned?$grade->earned:variable_get('gradebook_empty_grade', '--')), _gradebook_base_url().'/grade/'.$account->uid.'/'.$assignment->nid);
      }
      else {
        $row[] = ($grade->earned?$grade->earned:variable_get('gradebook_empty_grade', '--'));
      }
    }
    $grade = gradebookapi_get_term_grade($account->uid, $gradebook->tid);
    $row[] = $grade->earned . '/' . $grade->possible;
    $rows[] = $row;
  }
  return theme('table', $header, $rows);
}

function gradebook_category_page($gradebook) {
  // TODO: code borrowed from forum.module
  //       needs serious cleanup
  $vid = gradebookapi_get_vid();
  $destination = drupal_get_destination();

  $header = array(t('Name'), t('Operations'));
  $vocabulary = taxonomy_get_vocabulary($vid);

  drupal_set_title(check_plain($vocabulary->name));
  $start_from      = $_GET['page'] ? $_GET['page'] : 0;
  $total_entries   = 0;  // total count for pager
  $page_increment  = 25; // number of tids per page
  $displayed_count = 0;  // number of tids shown

  $tree = taxonomy_get_tree($vocabulary->vid, $gradebook->tid);
  foreach ($tree as $term) {
    $total_entries++; // we're counting all-totals, not displayed
    if (($start_from && ($start_from * $page_increment) >= $total_entries) || ($displayed_count == $page_increment)) { continue; }
    $rows[] = array(_taxonomy_depth($term->depth) . ' ' . l($term->name, _gradebook_base_url()."/category/edit/$term->tid"), l(t('edit'), _gradebook_base_url()."/category/edit/$term->tid", array(), $destination));
    $displayed_count++; // we're counting tids displayed
  }

  if (!$rows) {
    $rows[] = array(array('data' => t('No categories available.'), 'colspan' => '2'));
  }

  $GLOBALS['pager_page_array'][] = $start_from;  // FIXME
  $GLOBALS['pager_total'][] = intval($total_entries / $page_increment) + 1; // FIXME

  if ($total_entries >= $page_increment) {
    $rows[] = array(array('data' => theme('pager', NULL, $page_increment), 'colspan' => '2'));
  }

  return theme('table', $header, $rows, array('id' => 'taxonomy'));
}

function gradebook_category_form($gradebook, $edit = array()) {
  // Handle a delete operation.
  if ($_POST['op'] == t('Delete') || $_POST['edit']['confirm']) {
    return _gradebook_confirm_delete($edit['tid']);
  }
  
  $form['name'] = array(
    '#title' => t('Category name'),
    '#type' => 'textfield',
    '#default_value' => $edit['name'],
    '#maxlength' =>  64,
    '#description' => t('The category name is used to identify related assignments.'),
    '#required' => TRUE
  );

  $form['description'] = array(
    '#type' => 'textarea',
    '#title' => t('Description'),
    '#default_value' => $edit['description'],
    '#description' => t('The category description can give users more information about the assignments it contains.')
  );
  $form['parent']['#tree'] = TRUE;
  $form['parent'][0] = _gradebook_parent_select($gradebook->tid, $edit['tid'], t('Parent'));
  $form['weight'] = array(
    '#type' => 'weight',
    '#title' => t('Weight'),
    '#default_value' => $edit['weight'],
    '#description' => t('When listing categories, those with with light (small) weights get listed before containers with heavier (larger) weights. Categories with equal weights are sorted alphabetically.')
  );
  
  $form['vid'] = array(
    '#type' => 'hidden',
    '#value' => gradebookapi_get_vid(),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );
  if ($edit['tid']) {
    $form['tid'] = array(
      '#type' => 'hidden',
      '#value' => $edit['tid'],
    );
    $parents = taxonomy_get_parents($edit['tid']);
    if ($parents) {
      $parent = array_shift($parents);
      $form['parent_old'] = array(
        '#type' => 'hidden',
        '#value' => $parent->tid,
      );
    }
  
    $form['delete'] = array('#type' => 'submit', '#value' => t('Delete'));
  }

  return drupal_get_form('gradebook_category_form', $form, 'gradebook_form');
}

function gradebook_category_form_submit($form_id, $form_values) {
  $status = taxonomy_save_term($form_values);
  switch ($status) {
    case SAVED_NEW:
      drupal_set_message(t('Created new %type %term.', array('%term' => theme('placeholder', $form_values['name']), '%type' => t('category'))));
      break;
    case SAVED_UPDATED:
      if ($form_values['parent_old'] != $form_values['parent'][0]) {
        gradebookapi_calc_grades_all_users($form_values['parent_old']);
        gradebookapi_calc_grades_all_users($form_values['parent'][0]);
      }
      drupal_set_message(t('The %type %term has been updated.', array('%term' => theme('placeholder', $form_values['name']), '%type' => t('category'))));
      break;
  }
  return _gradebook_base_url().'/category'; 
}

function gradebook_grade_form($gradebook, $edit = array()) {
  $account = user_load(array('uid' => $edit['uid']));
  $node = node_load($edit['nid']);

  // TODO: cleanup grade form rendering
  //       ideally edit is in-place in gradebook using AJAX
  $form['user'] = array(
    '#value' => 'Student: ' . $account->name . "<br />\n",
  );
  
  $form['node'] = array(
    '#value' => 'Assignment: ' . $node->title . "<br />\n",
  );
  
  $form['possible'] = array(
    '#value' => 'Possible: ' . $node->possible . "<br />\n",
  );

  $form['overage'] = array(
    '#value' => 'Overage: ' . ($node->overage?'Yes':'No') . "<br />\n",
  );
  
  $form['earned'] = array(
    '#title' => t('Earned'),
    '#type' => 'textfield',
    '#default_value' => $edit['earned'],
    '#maxlength' =>  64,
    '#description' => t('The grade earned.'),
    '#required' => TRUE
  );

  $form['uid'] = array(
    '#type' => 'hidden',
    '#value' => $edit['uid'],
  );
  $form['nid'] = array(
    '#type' => 'hidden',
    '#value' => $edit['nid'],
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );

  return drupal_get_form('gradebook_grade_form', $form, 'gradebook_form');
}

function gradebook_grade_form_validate($form_id, $form_values) {
  $account = user_load(array('uid' => $form_values['uid']));
  $node = node_load($form_values['nid']);
  
  if (!$account || !$node) {
    form_set_error('', t('The UID/NID has an error.'));
  }

  if (!$node->overage) {
    if ($form_values['earned'] > $node->possible) {
      form_set_error('earned', t('You can not enter a value over the possible value for this assignment.'));
    }
  }
}

function gradebook_grade_form_submit($form_id, $form_values) {
  gradebookapi_set_grade((object)$form_values);
  drupal_set_message(t('Saved %type.', array('%type' => t('grade'))));
  return _gradebook_base_url(); 
}

// hook_form_alter
/*
function gradebook_form_alter($form_id, &$form) {
  // hide critical options from forum vocabulary
  if ($form_id == 'taxonomy_form_vocabulary') {
    if ($form['vid']['#value'] == _forum_get_vid()) {
      $form['help_forum_vocab'] = array(
        '#value' => t('This is the designated forum vocabulary. Some of the normal vocabulary options have been removed.'),
        '#weight' => -1,
      );
      $form['nodes']['forum'] = array('#type' => 'checkbox', '#value' => 1, '#title' => t('forum topic'), '#attributes' => array('disabled' => '' ), '#description' => t('forum topic is affixed to the forum vocabulary.'));
      $form['hierarchy'] = array('#type' => 'value', '#value' => 1);
      unset($form['relations']);
      unset($form['tags']);
      unset($form['multiple']);
      $form['required'] = array('#type' => 'value', '#value' => 1);
    }
    else {
      unset($form['nodes']['forum']);
    }
  }
}
*/

function _gradebook_parent_select($root, $tid, $title) {
  $parents = taxonomy_get_parents($tid);
  if ($parents) {
    $parent = array_shift($parents);
    $parent = $parent->tid;
  }
  else {
    $parent = $root;
  }

  $children = taxonomy_get_tree(gradebookapi_get_vid(), $tid);

  // A term can't be the child of itself, nor of its children.
  foreach ($children as $child) {
    $exclude[] = $child->tid;
  }
  $exclude[] = $tid;

  $tree = taxonomy_get_tree(gradebookapi_get_vid(), $root);
  $options[$root] = '<'. t('root') .'>';
  if ($tree) {
    foreach ($tree as $term) {
      if (!in_array($term->tid, $exclude)) {
        $options[$term->tid] = _taxonomy_depth($term->depth) . $term->name;
      }
    }
  }

  return array('#type' => 'select', '#title' => $title, '#default_value' => $parent, '#options' => $options, '#description' => $description, '#required' => TRUE);
}

function _gradebook_category_confirm_delete($tid) {
  $term = taxonomy_get_term($tid);

  $form['tid'] = array('#type' => 'value', '#value' => $tid);
  $form['name'] = array('#type' => 'value', '#value' => $term->name);

  return confirm_form('gradebook_category_confirm_delete', $form, t('Are you sure you want to delete the forum %name?', array('%name' => theme('placeholder', $term->name))), 'admin/forums', t('Deleting a forum or container will delete all sub-forums and associated posts as well. This action cannot be undone.'), t('Delete'), t('Cancel'));
}

function gradebook_category_confirm_delete_submit($form_id, $form_values) {
  taxonomy_del_term($form_values['tid']);
  drupal_set_message(t('The category %term and all sub-categories and associated assignments have been deleted.', array('%term' => theme('placeholder', $form_values['name']))));
  watchdog('content', t('gradebook: deleted %term and all its sub-categories and associated posts.', array('%term' => theme('placeholder', $form_values['name']))));

  return 'admin/forum';
}

function _gradebook_student_roles() {
  $roles = user_roles();
  unset($roles[DRUPAL_ANONYMOUS_RID]);
  unset($roles[DRUPAL_AUTHENTICATED_RID]);
  
  $sel_roles = (array) variable_get('gradebook_student_rids', array());
  foreach ($sel_roles as $rid => $value) {
    if (!$value) {
      unset($roles[$rid]);
    }
  }
  
  return $roles;
}

function _gradebook_teacher_roles() {
  $roles = user_roles();
  unset($roles[DRUPAL_ANONYMOUS_RID]);
  unset($roles[DRUPAL_AUTHENTICATED_RID]);
  
  $sel_roles = (array) variable_get('gradebook_teacher_rids', array());
  foreach ($sel_roles as $rid => $value) {
    if (!$value) {
      unset($roles[$rid]);
    }
  }
  
  return $roles;
}

function gradebook_rebuild_page($gradebook) {
  gradebookapi_rebuild_grades($gradebook->tid);
  drupal_goto(_gradebook_base_url());
}

function _gradebook_base_url() {
  if (is_numeric(arg(1))) {
    return 'gradebook/'.arg(1);
  }
  else {
    return 'gradebook';
  }
}
